{% extends 'admins/adminbase.html' %}

{% block title %}DevOrks - Applications Analytics{% endblock %}

{% block head_extra %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .analytics-wrapper {
        max-width: 1200px;
        margin: 32px auto 40px;
        padding: 26px 26px 30px;
        background: linear-gradient(135deg, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 0.9));
        border-radius: 22px;
        border: 1px solid rgba(148, 163, 184, 0.5);
        box-shadow:
            0 26px 70px rgba(15, 23, 42, 0.96),
            0 0 0 1px rgba(15, 23, 42, 0.9);
        backdrop-filter: blur(24px);
        -webkit-backdrop-filter: blur(24px);
    }

    .analytics-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        gap: 16px;
        margin-bottom: 22px;
    }

    .analytics-header h1 {
        margin: 0;
        font-size: 2.1rem;
        color: #f9fafb;
    }

    .analytics-subtitle {
        margin-top: 4px;
        font-size: 0.9rem;
        color: var(--text-color-faded);
    }

    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 14px;
        margin-bottom: 24px;
    }

    .metric-card {
        padding: 12px 14px;
        border-radius: 18px;
        border: 1px solid rgba(148, 163, 184, 0.5);
        background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.18), transparent 55%),
                    rgba(15, 23, 42, 0.96);
        box-shadow: 0 14px 38px rgba(15, 23, 42, 0.9);
    }

    .metric-label {
        font-size: 0.78rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--text-color-faded);
        margin-bottom: 6px;
    }

    .metric-value-main {
        font-size: 1.6rem;
        font-weight: 600;
        color: #f9fafb;
    }

    .metric-caption {
        font-size: 0.78rem;
        color: var(--text-color-faded);
        margin-top: 4px;
    }

    .charts-grid {
        display: grid;
        grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.1fr);
        gap: 18px;
        margin-bottom: 18px;
        align-items: stretch;
    }

    .chart-card {
        padding: 14px 16px 18px;
        border-radius: 18px;
        border: 1px solid rgba(148, 163, 184, 0.45);
        background: rgba(15, 23, 42, 0.98);
        box-shadow: 0 16px 40px rgba(15, 23, 42, 0.9);
        display: flex;
        flex-direction: column;
    }

    .chart-title {
        font-size: 0.95rem;
        color: #e5e7eb;
        margin-bottom: 8px;
    }

    .chart-card canvas {
        width: 100% !important;
        height: 260px !important;
        flex: 1 1 auto;
    }

    .table-shell {
        margin-top: 10px;
        border-radius: 14px;
        border: 1px solid rgba(30, 64, 175, 0.65);
        background: rgba(15, 23, 42, 0.95);
        overflow: hidden;
    }

    .mini-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.78rem;
    }

    .mini-table th,
    .mini-table td {
        padding: 7px 10px;
        border-bottom: 1px solid rgba(30, 64, 175, 0.5);
        text-align: left;
        white-space: nowrap;
    }

    .mini-table th {
        background: linear-gradient(135deg, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 0.94));
        color: #e5e7eb;
    }

    .mini-table tr:last-child td {
        border-bottom: none;
    }

    .tag-pill {
        display: inline-flex;
        align-items: center;
        padding: 2px 8px;
        border-radius: 999px;
        background-color: rgba(37, 99, 235, 0.25);
        color: #bfdbfe;
        font-size: 0.7rem;
    }

    #noApplicationsMessage {
        margin-top: 20px;
        text-align: center;
        font-size: 0.9rem;
        color: var(--text-color-faded);
    }

    @media (max-width: 900px) {
        .charts-grid {
            grid-template-columns: minmax(0, 1fr);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="analytics-wrapper">
    <div class="analytics-header">
        <div>
            <h1>Applications analytics</h1>
            <div class="analytics-subtitle">
                Snapshot of candidates, skills, and scores for your open roles.
            </div>
        </div>
        <div class="tag-pill" id="jobScopeLabel">
            Loading…
        </div>
    </div>

    <div class="metrics-grid">
        <div class="metric-card">
            <div class="metric-label">Total applications</div>
            <div class="metric-value-main" id="metricTotal">0</div>
            <div class="metric-caption" id="metricTotalCaption">Across all active jobs</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Gender mix</div>
            <div class="metric-value-main"><span id="metricMale">0</span> / <span id="metricFemale">0</span></div>
            <div class="metric-caption">Male / Female</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Experience (avg)</div>
            <div class="metric-value-main" id="metricAvgExp">0</div>
            <div class="metric-caption">Years of experience</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Scores (avg)</div>
            <div class="metric-caption">
                Resume: <span id="metricAvgResume">0</span> · MCQ: <span id="metricAvgMcq">0</span> · Coding:
                <span id="metricAvgCoding">0</span> · Interview: <span id="metricAvgInterview">0</span>
            </div>
        </div>
    </div>

    <div class="charts-grid">
        <div class="chart-card">
            <div class="chart-title">Gender distribution</div>
            <canvas id="genderChart"></canvas>
        </div>

        <div class="chart-card">
            <div class="chart-title">Experience buckets</div>
            <canvas id="experienceChart"></canvas>
        </div>
    </div>

    <div class="charts-grid">
        <div class="chart-card">
            <div class="chart-title">Average scores by stage</div>
            <canvas id="scoreChart"></canvas>
        </div>

        <div class="chart-card">
            <div class="chart-title">Top technical skills (from resumes)</div>
            <canvas id="skillsChart"></canvas>
        </div>
    </div>

    <p id="noApplicationsMessage" style="display:none;">No applications found.</p>
</div>

<script>
    document.addEventListener('DOMContentLoaded', fetchApplications);

    let genderChart, experienceChart, scoreChart, skillsChart;

    function safeAvg(values) {
        const nums = values.filter((v) => typeof v === 'number' && !isNaN(v));
        if (!nums.length) return 0;
        return +(nums.reduce((a, b) => a + b, 0) / nums.length).toFixed(1);
    }

    async function fetchApplications() {
        const noApplicationsMessage = document.getElementById('noApplicationsMessage');
        const jobScopeLabel = document.getElementById('jobScopeLabel');

        try {
            const response = await fetch('http://localhost:5000/admin/applications', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP ${response.status}: ${errorText}`);
            }

            const applications = await response.json();
            if (!applications.length) {
                noApplicationsMessage.style.display = 'block';
                jobScopeLabel.textContent = 'No active applications';
                return;
            }
            noApplicationsMessage.style.display = 'none';

            buildAnalytics(applications);
        } catch (err) {
            console.error('Error fetching applications:', err);
            noApplicationsMessage.textContent = `Failed to load analytics: ${err.message}`;
            noApplicationsMessage.style.display = 'block';
            jobScopeLabel.textContent = 'Error loading data';
        }
    }

    function buildAnalytics(applications) {
        const total = applications.length;

        const jobTitles = [...new Set(applications.map(a => a.job_title))];
        const jobScopeLabel = document.getElementById('jobScopeLabel');
        if (jobTitles.length === 1) {
            jobScopeLabel.textContent = jobTitles[0];
        } else {
            jobScopeLabel.textContent = `${jobTitles.length} roles`;
        }

        let male = 0, female = 0, other = 0;
        const expValues = [];
        const resumeScores = [];
        const mcqScores = [];
        const codingScores = [];
        const interviewScores = [];

        const expBuckets = {
            '0-1': 0,
            '1-3': 0,
            '3-5': 0,
            '5+': 0
        };

        const skillCounts = {};
        const trackedSkills = ['python', 'java', 'javascript', 'react', 'sql', 'c++', 'c#', 'node', 'django'];

        applications.forEach(app => {
            // Gender
            const g = (app.gender || '').toLowerCase().trim();
            if (g === 'male') male += 1;
            else if (g === 'female') female += 1;
            else other += 1;

            // Experience
            const exp = typeof app.applicant_experience === 'number'
                ? app.applicant_experience
                : parseFloat(app.applicant_experience || '0');
            if (!isNaN(exp) && exp > 0) {
                expValues.push(exp);
                if (exp <= 1) expBuckets['0-1'] += 1;
                else if (exp <= 3) expBuckets['1-3'] += 1;
                else if (exp <= 5) expBuckets['3-5'] += 1;
                else expBuckets['5+'] += 1;
            }

            // Scores
            if (app.resume_score != null) resumeScores.push(+app.resume_score);
            if (app.mcq_score != null) mcqScores.push(+app.mcq_score);
            if (app.coding_score != null) codingScores.push(+app.coding_score);
            if (app.interview_score != null) interviewScores.push(+app.interview_score);

            // Skills
            const skillsStr = (app.resume_skills || '').toLowerCase();
            if (skillsStr) {
                trackedSkills.forEach(skill => {
                    if (skillsStr.includes(skill)) {
                        skillCounts[skill] = (skillCounts[skill] || 0) + 1;
                    }
                });
            }
        });

        // Metrics
        document.getElementById('metricTotal').textContent = total;
        document.getElementById('metricTotalCaption').textContent = `${jobTitles.length} active role${jobTitles.length === 1 ? '' : 's'}`;
        document.getElementById('metricMale').textContent = male;
        document.getElementById('metricFemale').textContent = female;
        document.getElementById('metricAvgExp').textContent = safeAvg(expValues);
        document.getElementById('metricAvgResume').textContent = safeAvg(resumeScores);
        document.getElementById('metricAvgMcq').textContent = safeAvg(mcqScores);
        document.getElementById('metricAvgCoding').textContent = safeAvg(codingScores);
        document.getElementById('metricAvgInterview').textContent = safeAvg(interviewScores);

        // Charts
        const genderCtx = document.getElementById('genderChart').getContext('2d');
        const expCtx = document.getElementById('experienceChart').getContext('2d');
        const scoreCtx = document.getElementById('scoreChart').getContext('2d');
        const skillsCtx = document.getElementById('skillsChart').getContext('2d');

        if (genderChart) genderChart.destroy();
        if (experienceChart) experienceChart.destroy();
        if (scoreChart) scoreChart.destroy();
        if (skillsChart) skillsChart.destroy();

        genderChart = new Chart(genderCtx, {
            type: 'doughnut',
            data: {
                labels: ['Male', 'Female'],
                datasets: [{
                    data: [male, female],
                    backgroundColor: ['#38bdf8', '#f97316']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { labels: { color: '#e5e7eb' } }
                },
                cutout: '60%'
            }
        });

        experienceChart = new Chart(expCtx, {
            type: 'bar',
            data: {
                labels: Object.keys(expBuckets),
                datasets: [{
                    label: 'Candidates',
                    data: Object.values(expBuckets),
                    backgroundColor: '#4f46e5'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    x: {
                        ticks: { color: '#e5e7eb' },
                        grid: { display: false }
                    },
                    y: {
                        ticks: { color: '#9ca3af' },
                        grid: { color: 'rgba(55, 65, 81, 0.7)' }
                    }
                }
            }
        });

        scoreChart = new Chart(scoreCtx, {
            type: 'radar',
            data: {
                labels: ['Resume', 'MCQ', 'Coding', 'Interview'],
                datasets: [{
                    label: 'Average score',
                    data: [
                        safeAvg(resumeScores),
                        safeAvg(mcqScores),
                        safeAvg(codingScores),
                        safeAvg(interviewScores)
                    ],
                    backgroundColor: 'rgba(56, 189, 248, 0.18)',
                    borderColor: '#38bdf8',
                    borderWidth: 2,
                    pointBackgroundColor: '#38bdf8'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { labels: { color: '#e5e7eb' } } },
                scales: {
                    r: {
                        angleLines: { color: 'rgba(55, 65, 81, 0.7)' },
                        grid: { color: 'rgba(55, 65, 81, 0.7)' },
                        pointLabels: { color: '#e5e7eb' },
                        ticks: { display: false }
                    }
                }
            }
        });

        const topSkills = Object.entries(skillCounts)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 6);

        skillsChart = new Chart(skillsCtx, {
            type: 'bar',
            data: {
                labels: topSkills.map(s => s[0].toUpperCase()),
                datasets: [{
                    label: 'Candidates',
                    data: topSkills.map(s => s[1]),
                    backgroundColor: '#22c55e'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    x: {
                        ticks: { color: '#e5e7eb' },
                        grid: { display: false }
                    },
                    y: {
                        ticks: { color: '#9ca3af' },
                        grid: { color: 'rgba(55, 65, 81, 0.7)' }
                    }
                }
            }
        });
    }
</script>
{% endblock %}