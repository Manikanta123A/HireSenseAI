{% extends 'admins/adminbase.html' %}

{% block title %}Edit Job Post{% endblock %}

{% block content %}
  <div class="form-card">
    <h2 id="formTitle">Edit Job: <span id="currentJobTitle"></span></h2>
    <form id="editJobForm">
      <input type="hidden" id="jobId" />
      <label for="jobTitle">Job Title:</label>
      <input type="text" id="jobTitle" required />
      
      <label for="jobDescription">Job Description:</label>
      <textarea id="jobDescription" rows="4" required></textarea>
      
      <label for="qualifications">Qualifications:</label>
      <textarea id="qualifications" rows="3" required></textarea>
      
      <label for="responsibilities">Responsibilities:</label>
      <textarea id="responsibilities" rows="3" required></textarea>

      <label for="requiredExperience">Required Experience:</label>
      <input type="text" id="requiredExperience" placeholder="e.g., 2+ years, 5-7 years" required />

      <label for="nop">Number Of Positions:</label>
      <input type="number" id="nop" placeholder="e.g.,1,2,3" required />


      <button type="submit" class="btn btn-primary">Update Job</button>
    </form>
  </div>

  <script>

    document.addEventListener('DOMContentLoaded', async function() {
        const urlParams = new URLSearchParams(window.location.search);
        const jobId = urlParams.get('job_id');
        if (jobId) {
            document.getElementById('jobId').value = jobId;
            try {
                const response = await fetch(`/jobs/${jobId}`);
                const job = await response.json();

                if (response.ok) {
                    document.getElementById('currentJobTitle').textContent = job.title;
                    document.getElementById('jobTitle').value = job.title;
                    document.getElementById('jobDescription').value = job.description;
                    document.getElementById('qualifications').value = job.qualifications;
                    document.getElementById('responsibilities').value = job.responsibilities;
                    document.getElementById('requiredExperience').value = job.required_experience;
                    document.getElementById('nop').value = job.number_of_positions;
                
                } else {
                    showGlobalMessage(job.message, 'error');
                }
            } catch (err) {
                showGlobalMessage('Error fetching job details. Please try again.', 'error');
                console.error('Fetch error:', err);
            }
        } else {
            showGlobalMessage('No job ID provided for editing.', 'error', '/admin/applications');
        }
    });

    document.getElementById('editJobForm').addEventListener('submit', async function(event) {
        event.preventDefault();

        const jobId = document.getElementById('jobId').value;
        const formData = new FormData();
        formData.append('jobTitle', document.getElementById('jobTitle').value.trim());
        formData.append('jobDescription', document.getElementById('jobDescription').value.trim());
        formData.append('qualifications', document.getElementById('qualifications').value.trim());
        formData.append('responsibilities', document.getElementById('responsibilities').value.trim());
        formData.append('requiredExperience', document.getElementById('requiredExperience').value.trim());
        formData.append('number_of_positions',document.getElementById('nop').value) // Add this line

        try {
            const response = await fetch(`/jobs/${jobId}`, {
                method: 'PUT',
                body: formData
            });

            const result = await response.json();

            if (response.ok) {
                showGlobalMessage(result.message, 'success', '/admin/applications');
                window.location.href="http://localhost:5000/admin/applications"
                // No form reset needed for edit
            } else {
                showGlobalMessage(result.message, 'error');
                
            }
        } catch (err) {
            showGlobalMessage('Error updating job. Please try again.', 'error');
            console.error('Fetch error:', err);
        }
    });
  </script>
{% endblock %}